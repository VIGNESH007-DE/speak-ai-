<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic - Voice Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #socratic-bot {
            width: 200px;
            height: 200px;
            position: relative;
            transition: transform 0.5s ease-in-out;
        }
        .bot-core {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #4f46e5 0%, #1e1b4b 100%);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px #4f46e5, inset 0 0 20px rgba(255,255,255,0.3);
            animation: pulse 4s ease-in-out infinite;
        }
        .bot-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 3px solid;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.5;
        }
        .ring1 { width: 150px; height: 150px; border-color: #a78bfa; animation: rotate 20s linear infinite; }
        .ring2 { width: 180px; height: 180px; border-color: #7c3aed; animation: rotate-reverse 25s linear infinite; }
        .ring3 { width: 210px; height: 210px; border-color: #6d28d9; animation: rotate 30s linear infinite; }
        
        @keyframes pulse {
            50% { box-shadow: 0 0 45px #6366f1, inset 0 0 25px rgba(255,255,255,0.4); }
        }
        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes rotate-reverse {
            from { transform: translate(-50%, -50%) rotate(360deg); }
            to { transform: translate(-50%, -50%) rotate(0deg); }
        }

        #activate-btn.listening {
            animation: mic-pulse 1.5s infinite;
        }
        @keyframes mic-pulse {
            0%, 100% { box-shadow: 0 0 20px #22c55e; }
            50% { box-shadow: 0 0 40px #86efac; }
        }
        #timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: #f59e0b; /* Amber */
            text-shadow: 0 0 15px #f59e0b;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen p-4">

    <canvas id="background-canvas"></canvas>

    <div id="socratic-bot-container" class="mb-8">
        <div id="socratic-bot">
            <div class="bot-core"></div>
            <div class="bot-ring ring1"></div>
            <div class="bot-ring ring2"></div>
            <div class="bot-ring ring3"></div>
        </div>
    </div>

    <div id="status-display" class="text-center h-24">
        <div id="timer-display" class="h-12"></div>
        <p id="user-query" class="text-xl text-gray-400 h-1/2"></p>
        <p id="bot-answer" class="text-2xl font-bold text-white h-1/2"></p>
    </div>

    <button id="activate-btn" class="mt-8 bg-green-600 text-white rounded-full p-6 transition-all duration-300 hover:bg-green-500 focus:outline-none shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 8a1 1 0 100-2H8a1 1 0 100 2h4zM3 8a1 1 0 011-1h1v2H4a1 1 0 01-1-1zm13 0a1 1 0 00-1-1h-1v2h1a1 1 0 001-1z" clip-rule="evenodd" />
            <path d="M10 18a5 5 0 005-5h-2a3 3 0 01-6 0H5a5 5 0 005 5z" />
        </svg>
    </button>

    <script>
        // --- DOM Elements ---
        const backgroundCanvas = document.getElementById('background-canvas');
        const socraticBot = document.getElementById('socratic-bot');
        const activateBtn = document.getElementById('activate-btn');
        const userQueryDisplay = document.getElementById('user-query');
        const botAnswerDisplay = document.getElementById('bot-answer');
        const timerDisplay = document.getElementById('timer-display');

        // --- Background Animation ---
        const ctx = backgroundCanvas.getContext('2d');
        backgroundCanvas.width = window.innerWidth;
        backgroundCanvas.height = window.innerHeight;
        let particles = [];

        class Particle {
            constructor(x, y, directionX, directionY, size, color) {
                this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY;
                this.size = size; this.color = color;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
            update() {
                if (this.x > backgroundCanvas.width || this.x < 0) this.directionX = -this.directionX;
                if (this.y > backgroundCanvas.height || this.y < 0) this.directionY = -this.directionY;
                this.x += this.directionX;
                this.y += this.directionY;
                this.draw();
            }
        }

        function initParticles() {
            particles = [];
            let numberOfParticles = (backgroundCanvas.height * backgroundCanvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * .4) - .2;
                let directionY = (Math.random() * .4) - .2;
                let color = `rgba(79, 70, 229, ${Math.random()})`;
                particles.push(new Particle(x, y, directionX, directionY, size, color));
            }
        }

        function connectParticles() {
            for (let a = 0; a < particles.length; a++) {
                for (let b = a; b < particles.length; b++) {
                    let distance = Math.hypot(particles[a].x - particles[b].x, particles[a].y - particles[b].y);
                    if (distance < (backgroundCanvas.width/7) * (backgroundCanvas.height/7) / 100) {
                        ctx.strokeStyle=`rgba(129, 140, 248, ${1 - distance/200})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
            }
        }

        function animateBackground() {
            requestAnimationFrame(animateBackground);
            ctx.clearRect(0,0,innerWidth, innerHeight);
            particles.forEach(p => p.update());
            connectParticles();
        }
        
        initParticles();
        animateBackground();
        window.addEventListener('resize', () => {
            backgroundCanvas.width = window.innerWidth;
            backgroundCanvas.height = window.innerHeight;
            initParticles();
        });

        // --- Voice Recognition & Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        
        let isListening = false;
        let appState = 'idle'; // 'idle', 'awaitingDifficulty', 'inQuiz'
        let quizDifficulty = null;
        let currentQuizQuestion = null;
        let quizTimer;
        let quizScore = 0;

        recognition.onstart = () => {
            isListening = true;
            activateBtn.classList.add('listening');
            userQueryDisplay.textContent = "Listening...";
            botAnswerDisplay.textContent = "";
        };

        recognition.onend = () => {
            isListening = false;
            activateBtn.classList.remove('listening');
            if (appState === 'idle') {
                userQueryDisplay.textContent = "Say 'Start' to begin your math speed test.";
            }
        };
        
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            userQueryDisplay.textContent = "Sorry, I didn't catch that.";
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            userQueryDisplay.textContent = `You said: "${transcript}"`;
            await processQuery(transcript);
        };

        function speak(text, callback) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onstart = () => gsap.to(socraticBot, { scale: 1.1, duration: 0.3, ease: 'power2.out' });
            utterance.onend = () => {
                gsap.to(socraticBot, { scale: 1, duration: 0.5, ease: 'elastic.out(1, 0.3)' });
                if (callback) callback();
            };
            speechSynthesis.speak(utterance);
            botAnswerDisplay.textContent = text;
        }

        // --- Core Logic ---
        async function processQuery(query) {
            const lowerQuery = query.toLowerCase();

            switch (appState) {
                case 'idle':
                    // MODIFICATION: Added "start" as a trigger word
                    if (lowerQuery.includes("analyze me") || lowerQuery.includes("quiz me") || lowerQuery.includes("start")) {
                        appState = 'awaitingDifficulty';
                        speak("Which level would you like to try? Beginner, intermediate, or hard?");
                    } else {
                        speak("Say 'Start' to begin your math speed test.");
                    }
                    break;
                case 'awaitingDifficulty':
                    if (lowerQuery.includes("beginner")) {
                        quizDifficulty = 'beginner';
                        startQuiz();
                    } else if (lowerQuery.includes("intermediate")) {
                        quizDifficulty = 'intermediate';
                        startQuiz();
                    } else if (lowerQuery.includes("hard")) {
                        quizDifficulty = 'hard';
                        startQuiz();
                    } else {
                        speak("Please choose beginner, intermediate, or hard.");
                    }
                    break;
                case 'inQuiz':
                    checkQuizAnswer(lowerQuery);
                    break;
            }
        }
        
        // --- Quiz Mode Logic ---
        function generateQuizQuestion(difficulty) {
            let num1, num2, question, answer;
            switch(difficulty) {
                case 'beginner':
                    num1 = Math.floor(Math.random() * 20) + 1;
                    num2 = Math.floor(Math.random() * 20) + 1;
                    question = `What is ${num1} plus ${num2}?`;
                    answer = num1 + num2;
                    break;
                case 'intermediate':
                    const op = ['-', '*'][Math.floor(Math.random() * 2)];
                    if (op === '-') {
                        num1 = Math.floor(Math.random() * 80) + 20;
                        num2 = Math.floor(Math.random() * 20) + 1;
                        question = `What is ${num1} minus ${num2}?`;
                        answer = num1 - num2;
                    } else {
                        num1 = Math.floor(Math.random() * 11) + 2; // 2-12
                        num2 = Math.floor(Math.random() * 11) + 2; // 2-12
                        question = `What is ${num1} times ${num2}?`;
                        answer = num1 * num2;
                    }
                    break;
                case 'hard':
                    const hardOp = ['/', 'fraction'][Math.floor(Math.random() * 2)];
                    if (hardOp === '/') {
                        answer = Math.floor(Math.random() * 10) + 2;
                        num2 = Math.floor(Math.random() * 10) + 3;
                        num1 = answer * num2;
                        question = `What is ${num1} divided by ${num2}?`;
                    } else {
                        const den = [2, 4, 5, 10][Math.floor(Math.random() * 4)];
                        const mult = Math.floor(Math.random() * 10) + 2;
                        const num = den * mult;
                        question = `What is one-${den === 2 ? 'half' : (den === 4 ? 'fourth' : 'fifth')} of ${num}?`;
                        answer = mult;
                    }
                    break;
            }
            return { question, answer };
        }

        function startQuiz() {
            appState = 'inQuiz';
            currentQuizQuestion = 0;
            quizScore = 0;
            speak(`Starting the ${quizDifficulty} challenge! 10 questions, 20 seconds each. Let's begin.`, askQuizQuestion);
        }

        function askQuizQuestion() {
            if (currentQuizQuestion < 10) {
                const q = generateQuizQuestion(quizDifficulty);
                window.currentQuizAnswer = q.answer;
                speak(q.question);
                userQueryDisplay.textContent = q.question;
                startTimer();
            } else {
                endQuiz();
            }
        }
        
        function startTimer() {
            let timeLeft = 20;
            timerDisplay.textContent = timeLeft;
            clearInterval(quizTimer);
            quizTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    speak(`Time's up! The answer was ${window.currentQuizAnswer}.`, () => {
                        currentQuizQuestion++;
                        askQuizQuestion();
                    });
                }
            }, 1000);
        }

        function checkQuizAnswer(userAnswer) {
            clearInterval(quizTimer);
            const numbersInAnswer = userAnswer.match(/-?\d+/g); // handle negative numbers
            const answerAsNumber = numbersInAnswer ? parseInt(numbersInAnswer[0]) : NaN;

            if (answerAsNumber === window.currentQuizAnswer) {
                quizScore++;
                speak("Correct!", () => {
                    currentQuizQuestion++;
                    askQuizQuestion();
                });
            } else {
                speak(`Not quite. The correct answer was ${window.currentQuizAnswer}.`, () => {
                    currentQuizQuestion++;
                    askQuizQuestion();
                });
            }
        }
        
        function endQuiz() {
            appState = 'idle';
            quizDifficulty = null;
            currentQuizQuestion = null;
            timerDisplay.textContent = '';
            speak(`Quiz complete! You scored ${quizScore} out of 10. Well done!`);
            userQueryDisplay.textContent = "Quiz finished! Say 'Start' to begin a new test.";
        }

        // --- Event Listeners ---
        activateBtn.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
            }
        });
        
        // Initial welcome message
        speak("Hello! I am Socratic. Say 'Start' to begin your math speed test.");

    </script>
</body>
</html>
