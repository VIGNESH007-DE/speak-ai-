<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic - Voice Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #4f46e5);
            background-size: 400% 400%;
            animation: background-pan 15s ease infinite;
            color: #e0e0e0;
            overflow: hidden;
        }

        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #socratic-bot {
            width: 150px; /* Adjusted for better mobile layout */
            height: 150px;
            position: relative;
            transition: transform 0.5s ease-in-out;
        }
        .bot-core {
            width: 75px; /* Adjusted */
            height: 75px;
            background: radial-gradient(circle, #4f46e5 0%, #1e1b4b 100%);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 25px #4f46e5, inset 0 0 15px rgba(255,255,255,0.3);
            animation: pulse 4s ease-in-out infinite;
        }
        .bot-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 2px solid; /* Adjusted */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.5;
        }
        .ring1 { width: 110px; height: 110px; border-color: #a78bfa; animation: rotate 20s linear infinite; }
        .ring2 { width: 130px; height: 130px; border-color: #7c3aed; animation: rotate-reverse 25s linear infinite; }
        .ring3 { width: 150px; height: 150px; border-color: #6d28d9; animation: rotate 30s linear infinite; }
        
        @keyframes pulse {
            50% { box-shadow: 0 0 40px #6366f1, inset 0 0 20px rgba(255,255,255,0.4); }
        }
        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes rotate-reverse {
            from { transform: translate(-50%, -50%) rotate(360deg); }
            to { transform: translate(-50%, -50%) rotate(0deg); }
        }

        #activate-btn.listening {
            animation: mic-pulse 1.5s infinite;
        }
        @keyframes mic-pulse {
            0%, 100% { box-shadow: 0 0 20px #22c55e; }
            50% { box-shadow: 0 0 40px #86efac; }
        }
        #timer-display {
            font-size: 2.5rem; /* Adjusted */
            font-weight: 700;
            color: #f59e0b;
            text-shadow: 0 0 15px #f59e0b;
        }
        
        /* --- Layout and Text Display Fixes --- */
        #main-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes content apart */
            align-items: center;
            height: 100vh;
            padding: 1rem;
        }
        #status-display {
            min-height: 8rem; /* Allows text to wrap without overlap */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- Feedback Animations --- */
        #feedback-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 100;
        }
        .heart {
            position: absolute;
            font-size: 2rem;
            animation: float-up 3s ease-out forwards;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100vh) scale(1.5); opacity: 0; }
        }
        .sad-emoji {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 8rem;
            opacity: 0;
            animation: pop-up 1.5s ease-out forwards;
        }
        @keyframes pop-up {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="feedback-container"></div>

    <div id="main-container">
        <div id="socratic-bot-container">
            <div id="socratic-bot">
                <div class="bot-core"></div>
                <div class="bot-ring ring1"></div>
                <div class="bot-ring ring2"></div>
                <div class="bot-ring ring3"></div>
            </div>
        </div>

        <div id="status-display" class="text-center">
            <div id="timer-display" class="mb-2"></div>
            <p id="user-query" class="text-lg text-gray-400"></p>
            <p id="bot-answer" class="text-xl font-bold text-white"></p>
        </div>

        <button id="activate-btn" class="bg-green-600 text-white rounded-full p-5 transition-all duration-300 hover:bg-green-500 focus:outline-none shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 8a1 1 0 100-2H8a1 1 0 100 2h4zM3 8a1 1 0 011-1h1v2H4a1 1 0 01-1-1zm13 0a1 1 0 00-1-1h-1v2h1a1 1 0 001-1z" clip-rule="evenodd" />
                <path d="M10 18a5 5 0 005-5h-2a3 3 0 01-6 0H5a5 5 0 005 5z" />
            </svg>
        </button>
    </div>

    <script>
        // --- DOM Elements ---
        const socraticBot = document.getElementById('socratic-bot');
        const activateBtn = document.getElementById('activate-btn');
        const userQueryDisplay = document.getElementById('user-query');
        const botAnswerDisplay = document.getElementById('bot-answer');
        const timerDisplay = document.getElementById('timer-display');
        const feedbackContainer = document.getElementById('feedback-container');

        // --- Voice Recognition & Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        
        let isListening = false;
        let appState = 'idle'; // 'idle', 'awaitingDifficulty', 'inQuiz'
        let quizDifficulty = null;
        let currentQuizQuestion = 0;
        let quizTimer;
        let quizScore = 0;

        recognition.onstart = () => {
            isListening = true;
            activateBtn.classList.add('listening');
            userQueryDisplay.textContent = "Listening...";
            botAnswerDisplay.textContent = "";
        };

        recognition.onend = () => {
            isListening = false;
            activateBtn.classList.remove('listening');
            if (userQueryDisplay.textContent === "Listening...") {
                userQueryDisplay.textContent = "I didn't hear anything.";
            }
        };
        
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            userQueryDisplay.textContent = "Sorry, I had trouble hearing.";
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            userQueryDisplay.textContent = `You said: "${transcript}"`;
            await processQuery(transcript);
        };

        function speak(text, shouldListenAfter = false) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onstart = () => gsap.to(socraticBot, { scale: 1.1, duration: 0.3, ease: 'power2.out' });
            utterance.onend = () => {
                gsap.to(socraticBot, { scale: 1, duration: 0.5, ease: 'elastic.out(1, 0.3)' });
                if (shouldListenAfter && !isListening) {
                    recognition.start();
                }
            };
            speechSynthesis.speak(utterance);
            botAnswerDisplay.textContent = text;
        }

        // --- Feedback Animations ---
        function showHearts() {
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.classList.add('heart');
                    heart.textContent = 'â¤ï¸';
                    heart.style.left = `${Math.random() * 100}vw`;
                    heart.style.animationDuration = `${(Math.random() * 2) + 2}s`;
                    feedbackContainer.appendChild(heart);
                    setTimeout(() => heart.remove(), 4000);
                }, i * 100);
            }
        }

        function showSadEmoji() {
            const sadEmoji = document.createElement('div');
            sadEmoji.classList.add('sad-emoji');
            sadEmoji.textContent = 'ðŸ˜¢';
            feedbackContainer.appendChild(sadEmoji);
            setTimeout(() => sadEmoji.remove(), 1500);
        }

        // --- Core Logic ---
        async function processQuery(query) {
            const lowerQuery = query.toLowerCase();

            switch (appState) {
                case 'idle':
                    if (lowerQuery.includes("start")) {
                        appState = 'awaitingDifficulty';
                        speak("Which level would you like to try? Beginner, intermediate, or hard?", true);
                    } else {
                        speak("Say 'Start' to begin your math speed test.");
                    }
                    break;
                case 'awaitingDifficulty':
                    if (lowerQuery.includes("beginner")) {
                        quizDifficulty = 'beginner';
                        startQuiz();
                    } else if (lowerQuery.includes("intermediate")) {
                        quizDifficulty = 'intermediate';
                        startQuiz();
                    } else if (lowerQuery.includes("hard")) {
                        quizDifficulty = 'hard';
                        startQuiz();
                    } else {
                        speak("Please choose beginner, intermediate, or hard.", true);
                    }
                    break;
                case 'inQuiz':
                    checkQuizAnswer(lowerQuery);
                    break;
            }
        }
        
        // --- Quiz Mode Logic ---
        function generateQuizQuestion(difficulty) {
            let num1, num2, question, answer;
            switch(difficulty) {
                case 'beginner':
                    num1 = Math.floor(Math.random() * 20) + 1;
                    num2 = Math.floor(Math.random() * 20) + 1;
                    question = `What is ${num1} plus ${num2}?`;
                    answer = num1 + num2;
                    break;
                case 'intermediate':
                    const op = ['-', '*'][Math.floor(Math.random() * 2)];
                    if (op === '-') {
                        num1 = Math.floor(Math.random() * 80) + 20;
                        num2 = Math.floor(Math.random() * 20) + 1;
                        question = `What is ${num1} minus ${num2}?`;
                        answer = num1 - num2;
                    } else {
                        num1 = Math.floor(Math.random() * 11) + 2;
                        num2 = Math.floor(Math.random() * 11) + 2;
                        question = `What is ${num1} times ${num2}?`;
                        answer = num1 * num2;
                    }
                    break;
                case 'hard':
                    const hardOp = ['/', 'fraction'][Math.floor(Math.random() * 2)];
                    if (hardOp === '/') {
                        answer = Math.floor(Math.random() * 10) + 2;
                        num2 = Math.floor(Math.random() * 10) + 3;
                        num1 = answer * num2;
                        question = `What is ${num1} divided by ${num2}?`;
                    } else {
                        const den = [2, 4, 5, 10][Math.floor(Math.random() * 4)];
                        const mult = Math.floor(Math.random() * 10) + 2;
                        const num = den * mult;
                        question = `What is one-${den === 2 ? 'half' : (den === 4 ? 'fourth' : 'fifth')} of ${num}?`;
                        answer = mult;
                    }
                    break;
            }
            return { question, answer };
        }

        function startQuiz() {
            appState = 'inQuiz';
            currentQuizQuestion = 0;
            quizScore = 0;
            speak(`Starting the ${quizDifficulty} challenge! 10 questions, 20 seconds each. Let's begin.`, false);
            setTimeout(askQuizQuestion, 4000); // Give user time to prepare
        }

        function askQuizQuestion() {
            if (currentQuizQuestion < 10) {
                const q = generateQuizQuestion(quizDifficulty);
                window.currentQuizAnswer = q.answer;
                speak(q.question, true);
                userQueryDisplay.textContent = q.question;
                startTimer();
            } else {
                endQuiz();
            }
        }
        
        function startTimer() {
            let timeLeft = 20;
            timerDisplay.textContent = timeLeft;
            clearInterval(quizTimer);
            quizTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    showSadEmoji();
                    speak(`Time's up! The answer was ${window.currentQuizAnswer}.`, false);
                    currentQuizQuestion++;
                    setTimeout(askQuizQuestion, 2000);
                }
            }, 1000);
        }

        function checkQuizAnswer(userAnswer) {
            clearInterval(quizTimer);
            const numbersInAnswer = userAnswer.match(/-?\d+/g);
            const answerAsNumber = numbersInAnswer ? parseInt(numbersInAnswer[0]) : NaN;

            if (answerAsNumber === window.currentQuizAnswer) {
                quizScore++;
                showHearts();
                speak("Correct!", false);
            } else {
                showSadEmoji();
                speak(`Not quite. The correct answer was ${window.currentQuizAnswer}.`, false);
            }
            currentQuizQuestion++;
            setTimeout(askQuizQuestion, 2000); // Wait 2 seconds before next question
        }
        
        function endQuiz() {
            appState = 'idle';
            quizDifficulty = null;
            currentQuizQuestion = 0;
            timerDisplay.textContent = '';
            speak(`Quiz complete! You scored ${quizScore} out of 10. Well done!`);
            userQueryDisplay.textContent = "Quiz finished! Say 'Start' to begin a new test.";
        }

        // --- Event Listeners ---
        activateBtn.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
            }
        });
        
        // Initial welcome message
        speak("Hello! I am Socratic. Say 'Start' to begin your math speed test.");

    </script>
</body>
</html>
